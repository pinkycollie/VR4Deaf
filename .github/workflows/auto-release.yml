name: Auto Release

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      release_type:
        description: 'Release type'
        required: true
        default: 'patch'
        type: choice
        options:
          - patch
          - minor
          - major

jobs:
  release:
    runs-on: ubuntu-latest
    name: Create Release
    permissions:
      contents: write
      pull-requests: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --legacy-peer-deps

      - name: Run tests
        run: npm test
        env:
          CI: true

      - name: Build project
        run: npm run build
        env:
          CI: true

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Determine version bump
        id: version
        run: |
          CURRENT_VERSION=$(node -p "require('./package.json').version")
          echo "current_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          
          # Determine bump type from commit messages or workflow input
          BUMP_TYPE="${{ github.event.inputs.release_type }}"
          
          if [ -z "$BUMP_TYPE" ]; then
            # Auto-determine from commit messages
            if git log --format=%B -n 1 | grep -qE "^(feat|feature):"; then
              BUMP_TYPE="minor"
            elif git log --format=%B -n 1 | grep -qE "^(BREAKING CHANGE:|major:)"; then
              BUMP_TYPE="major"
            else
              BUMP_TYPE="patch"
            fi
          fi
          
          echo "bump_type=$BUMP_TYPE" >> $GITHUB_OUTPUT

      - name: Bump version
        id: bump
        run: |
          BUMP_TYPE="${{ steps.version.outputs.bump_type }}"
          npm version $BUMP_TYPE -m "chore: bump version to %s [skip ci]"
          
          NEW_VERSION=$(node -p "require('./package.json').version")
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT

      - name: Generate changelog
        id: changelog
        run: |
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          
          if [ -z "$PREV_TAG" ]; then
            COMMITS=$(git log --pretty=format:"- %s (%h)" --no-merges)
          else
            COMMITS=$(git log $PREV_TAG..HEAD --pretty=format:"- %s (%h)" --no-merges)
          fi
          
          CHANGELOG="## What's Changed\n\n$COMMITS"
          
          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          echo -e "$CHANGELOG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: v${{ steps.bump.outputs.new_version }}
          release_name: Release v${{ steps.bump.outputs.new_version }}
          body: |
            # VR4Deaf Platform v${{ steps.bump.outputs.new_version }}
            
            ${{ steps.changelog.outputs.changelog }}
            
            ## Installation
            
            ```bash
            git clone https://github.com/${{ github.repository }}.git
            cd VR4Deaf
            git checkout v${{ steps.bump.outputs.new_version }}
            npm install --legacy-peer-deps
            npm run build
            ```
            
            ## Accessibility
            
            This release maintains WCAG 2.1 AA compliance and includes:
            - Deaf-first design principles
            - Full keyboard navigation support
            - Screen reader optimization
            - Visual-only notifications
            
            ---
            
            *Generated by Auto Release workflow*
          draft: false
          prerelease: false

      - name: Push changes
        run: |
          git push --follow-tags origin main

      - name: Create release summary
        run: |
          cat << EOF >> $GITHUB_STEP_SUMMARY
          ## ðŸš€ Release Created
          
          **Version**: v${{ steps.bump.outputs.new_version }}
          **Previous Version**: v${{ steps.version.outputs.current_version }}
          **Type**: ${{ steps.version.outputs.bump_type }}
          
          ### Changes
          ${{ steps.changelog.outputs.changelog }}
          
          ### Release Notes
          View the full release at: https://github.com/${{ github.repository }}/releases/tag/v${{ steps.bump.outputs.new_version }}
          EOF

  publish-docs:
    runs-on: ubuntu-latest
    name: Publish Documentation
    needs: release
    if: success()
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Generate documentation site
        run: |
          mkdir -p docs-site
          
          cat << 'EOF' > docs-site/index.html
          <!DOCTYPE html>
          <html lang="en">
          <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>VR4Deaf Documentation</title>
            <style>
              body { font-family: Arial, sans-serif; max-width: 1200px; margin: 0 auto; padding: 20px; }
              h1 { color: #333; }
              .section { margin: 20px 0; padding: 20px; border: 1px solid #ddd; border-radius: 5px; }
            </style>
          </head>
          <body>
            <h1>VR4Deaf Platform Documentation</h1>
            <div class="section">
              <h2>Latest Release</h2>
              <p>Documentation for the latest release is available on GitHub.</p>
              <a href="https://github.com/${{ github.repository }}">View on GitHub</a>
            </div>
          </body>
          </html>
          EOF

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        if: github.ref == 'refs/heads/main'
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./docs-site
          publish_branch: gh-pages
